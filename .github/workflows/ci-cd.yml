name: CI-CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # üîç SonarQube Scan
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      # üö¶ Quality Gate
      - name: SonarQube Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # üöÄ Deploy to EC2
      - name: SSH into EC2 and deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker rm -f python-app || true
            docker build -t python-app .
            docker run -d -p 5000:5000 --name python-app python-app

      # ‚úÖ Email on SUCCESS
      - name: Send Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: 3.238.32.56
          server_port: 1025
          subject: "CI/CD Pipeline SUCCESS üöÄ"
          body: |
            Hello Sara,

            Your CI/CD pipeline completed successfully.

            - Repository: ci-cd
            - SonarQube Quality Gate: PASSED
            - Deployment: SUCCESS
            - EC2: 3.238.32.56

            Regards,
            CI/CD Pipeline
          to: devops@local.dev
          from: ci-cd@local.dev

      # ‚ùå Email on FAILURE
      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: 3.238.32.56
          server_port: 1025
          subject: "CI/CD Pipeline FAILED ‚ùå"
          body: |
            Hello Sara,

            Your CI/CD pipeline FAILED.

            Please check GitHub Actions logs for details.

            - Repository: ci-cd
            - EC2: 3.238.32.56

            Regards,
            CI/CD Pipeline
          to: devops@local.dev
          from: ci-cd@local.dev
